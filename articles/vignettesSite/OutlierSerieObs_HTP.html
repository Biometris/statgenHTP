<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>statgenHTP tutorial: 4. Outlier detection for series of observations • statgenHTP</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="statgenHTP tutorial: 4. Outlier detection for series of observations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">statgenHTP</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../index.html" aria-label="home"><span class="fa fa-home"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../../articles/index.html">Vignettes</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../../news/index.html"><span class="fa fa-newspaper-o"></span> news</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference/index.html"><span class="fa fa-file-code-o"></span> functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-seedling"></span> other packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://biometris.github.io/statgenSTA">statgenSTA</a></li>
    <li><a class="external-link dropdown-item" href="https://biometris.github.io/statgenGxE">statgenGxE</a></li>
    <li><a class="external-link dropdown-item" href="https://biometris.github.io/statgenGWAS">statgenGWAS</a></li>
    <li><a class="external-link dropdown-item" href="https://biometris.github.io/statgenQTLxT">statgenQTLxT</a></li>
    <li><a class="external-link dropdown-item" href="https://biometris.github.io/statgenIBD">statgenIBD</a></li>
    <li><a class="external-link dropdown-item" href="https://biometris.github.io/statgenMPP">statgenMPP</a></li>
    <li><a class="external-link dropdown-item" href="https://biometris.github.io/LMMsolver">LMMsolver</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Biometris/statgenHTP"><span class="fa fa-github fa-lg fab"></span> github</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>statgenHTP tutorial: 4. Outlier detection for series of observations</h1>
                        <h4 data-toc-skip class="author">Emilie Millet,
Bart-Jan van Rossum, Isabelle Sanchez, Nadine Hilgert, Fred van
Eeuwijk</h4>
            
            <h4 data-toc-skip class="date">2025-07-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Biometris/statgenHTP/blob/main/vignettes/vignettesSite/OutlierSerieObs_HTP.Rmd" class="external-link"><code>vignettes/vignettesSite/OutlierSerieObs_HTP.Rmd</code></a></small>
      <div class="d-none name"><code>OutlierSerieObs_HTP.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document describes a protocol to detect outlying time courses,
observed on a single plant or plot, with examples from various
platforms. Traits may be measured directly or indirectly (through image
analysis for example). The protocol considers time series on single
traits. The protocol is applicable to raw data or data that were
corrected spatially before (see <a href="SpatialModel_HTP.html"><strong>statgenHTP tutorial: 3. Correction
for spatial trends</strong></a>) or on raw data.</p>
<div class="section level3">
<h3 id="a-nonparametric-smoothing-associated-with-a-pca">A nonparametric smoothing associated with a PCA<a class="anchor" aria-label="anchor" href="#a-nonparametric-smoothing-associated-with-a-pca"></a>
</h3>
<p>Each time course is modeled by a non-parametric smoothing spline with
a fixed number of knots. This is a piecewise cubic polynomial (<span class="citation">(<a href="#ref-Eubank1999">Eubank 1999</a>)</span>,
<span class="citation">(<a href="#ref-Eilers2015">Eilers, Marx, and
Durbán 2015</a>)</span>) fitted as a mixed model (<span class="citation">(<a href="#ref-Currie2002">Currie and Durban
2002</a>)</span>).</p>
<div class="figure">
<img src="figures/pspline.png" alt="P-spline smoothing with 20 knots and a low penalty, from [@Hugelier2016]. The individual B-splines (with the correct coefficients) are shown (colored lines), as well as their sum representing the fit (thick black line)." width="40%"><p class="caption">
P-spline smoothing with 20 knots and a low penalty, from <span class="citation">(<a href="#ref-Hugelier2016">Hugelier, Devos, and
Ruckebusch 2016</a>)</span>. The individual B-splines (with the correct
coefficients) are shown (colored lines), as well as their sum
representing the fit (thick black line).
</p>
</div>
<p>The estimates for the spline coefficients are then extracted per time
course (typically per plant) and correlations between those coefficient
vectors are calculated to identify outlying time courses, <em>i.e.</em>,
plants. An outlying time course will have low correlation to the
majority of time courses. To support the analysis by correlations, a
principal component analysis can be done on the plant (time course) by
spline coefficient matrix. A PCA plot of the plant scores will show the
outlying plants.</p>
<p>For P-splines in a mixed model, the smoothing coefficient is
optimized by restricted maximum likelihood but the number of knots is
chosen by the user.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="principal-component-analysis-on-smoothed-time-series-to-identify-outlying-series-">Principal component analysis on smoothed time series to identify
outlying series.<a class="anchor" aria-label="anchor" href="#principal-component-analysis-on-smoothed-time-series-to-identify-outlying-series-"></a>
</h2>
<p>The function <code><a href="../../reference/fitSpline.html">fitSpline()</a></code> fits a P-spline per plant for
the selected <code>trait</code>. The penalty (i.e. the amount of
smoothing) will be chosen by REML and the number of knots can be
determined by the user using <code>knots</code>. In P-spline, the knots
are equally spaced and their number can be large. The user should also
chose an appropriate minimum number of time points that should be in the
data set per plant <code>minNoTP</code>. When a plant has less time
points than the minimum, it will be skipped from the analysis.</p>
<p>The functions are illustrated with the three example data sets. For
more information about the data, see <a href="Intro_HTP.html"><strong>statgenHTP tutorial: 1.
Introduction</strong></a>.</p>
<div class="section level3">
<h3 id="example-1">Example 1<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h3>
<p>The data from the Phenovator platform have been corrected for spatial
trends and time points outliers have been removed (see <a href="OutlierSingleObs_HTP.html"><strong>statgenHTP tutorial: 2. Outlier
detection for single observations</strong></a> and <a href="SpatialModel_HTP.html"><strong>statgenHTP tutorial: 3. Correction
for spatial trends</strong></a>). At this stage, the cleaned and
corrected data are used:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">spatCorrectedVator</span><span class="op">)</span>  </span>
<span><span class="co"># Fit P-splines using on a subset of genotypes.</span></span>
<span><span class="va">subGenoVator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G070"</span>, <span class="st">"G160"</span>, <span class="st">"G151"</span>, <span class="st">"G179"</span>, <span class="st">"G175"</span>, <span class="st">"G004"</span>, <span class="st">"G055"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit.spline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitSpline.html">fitSpline</a></span><span class="op">(</span>inDat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                        trait <span class="op">=</span> <span class="st">"EffpsII_corr"</span>,</span>
<span>                        genotypes <span class="op">=</span> <span class="va">subGenoVator</span>,</span>
<span>                        knots <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="co"># Extracting the tables of predicted values and P-spline coefficients</span></span>
<span><span class="va">predDat</span> <span class="op">&lt;-</span> <span class="va">fit.spline</span><span class="op">$</span><span class="va">predDat</span></span>
<span><span class="va">coefDat</span> <span class="op">&lt;-</span> <span class="va">fit.spline</span><span class="op">$</span><span class="va">coefDat</span></span></code></pre></div>
<p>The object <code>fit.spline</code> contains the P-spline model
coefficients (<code>coefDat</code>) and the predicted value
(<code>pred.value</code> in the table below), i.e the values predicted
using the P-spline model coefficients. Predictions are made on a denser
grid of time points: the time points for prediction are calculated as
the smallest gap between two time points divided by 9, so dividing the
smallest gap in 10 segments. The object <code>fit.spline</code> also
contains the first and second derivatives (<code>deriv</code> and
<code>deriv2</code> in the table below, see also <a href="ParameterEstimation_HTP.html"><strong>statgenHTP tutorial: 6.
Estimation of parameters from time courses</strong></a>).</p>
<table class="table">
<colgroup>
<col width="15%">
<col width="26%">
<col width="15%">
<col width="10%">
<col width="10%">
<col width="10%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="center">timeNumber</th>
<th align="center">timePoint</th>
<th align="center">pred.value</th>
<th align="center">deriv</th>
<th align="center">deriv2</th>
<th align="center">plotId</th>
<th align="center">genotype</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">2018-05-31 16:37:00</td>
<td align="center">0.6687993</td>
<td align="center">-8e-07</td>
<td align="center">0</td>
<td align="center">c10r29</td>
<td align="center">G160</td>
</tr>
<tr class="even">
<td align="center">800</td>
<td align="center">2018-05-31 16:50:20</td>
<td align="center">0.6681258</td>
<td align="center">-8e-07</td>
<td align="center">0</td>
<td align="center">c10r29</td>
<td align="center">G160</td>
</tr>
<tr class="odd">
<td align="center">1600</td>
<td align="center">2018-05-31 17:03:40</td>
<td align="center">0.6674536</td>
<td align="center">-8e-07</td>
<td align="center">0</td>
<td align="center">c10r29</td>
<td align="center">G160</td>
</tr>
<tr class="even">
<td align="center">2400</td>
<td align="center">2018-05-31 17:17:00</td>
<td align="center">0.6667829</td>
<td align="center">-8e-07</td>
<td align="center">0</td>
<td align="center">c10r29</td>
<td align="center">G160</td>
</tr>
<tr class="odd">
<td align="center">3200</td>
<td align="center">2018-05-31 17:30:20</td>
<td align="center">0.6661139</td>
<td align="center">-8e-07</td>
<td align="center">0</td>
<td align="center">c10r29</td>
<td align="center">G160</td>
</tr>
<tr class="even">
<td align="center">4000</td>
<td align="center">2018-05-31 17:43:40</td>
<td align="center">0.6654466</td>
<td align="center">-8e-07</td>
<td align="center">0</td>
<td align="center">c10r29</td>
<td align="center">G160</td>
</tr>
</tbody>
</table>
<p>Conversion to numerical time is required to fit P-splines. To keep
the same time scale as in the original <code>timePoint</code> column, a
numerical transformation of the time points is made using the first time
point as origin (column <code>timeNumber</code> in the table
above).<br>
The numerical time can also be provided by the user using the option
<code>useTimeNumber = TRUE</code>. It allows using thermal time or any
other manual conversion. In this example, we provide a new column
specified in <code>timeNumber</code> with time in hours since first
measurement.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.splineNum</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitSpline.html">fitSpline</a></span><span class="op">(</span>inDat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                           trait <span class="op">=</span> <span class="st">"EffpsII_corr"</span>,</span>
<span>                           genotypes <span class="op">=</span> <span class="va">subGenoVator</span>,</span>
<span>                           knots <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                           useTimeNumber <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                           timeNumber <span class="op">=</span> <span class="st">"timeNumHour"</span><span class="op">)</span></span></code></pre></div>
<p>We can then visualize the P-spline predictions and first derivatives
for a subset of genotypes or for a subset of plots.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.spline</span>,</span>
<span>     genotypes <span class="op">=</span> <span class="st">"G160"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotSplGeno-1.png" width="672"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.spline</span>,</span>
<span>     plotIds <span class="op">=</span> <span class="st">"c10r29"</span>,</span>
<span>     plotType <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotSplPlot-1.png" width="384"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.spline</span>,</span>
<span>     plotIds <span class="op">=</span> <span class="st">"c10r29"</span>,</span>
<span>     plotType <span class="op">=</span> <span class="st">"derivatives"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotSplPlot-2.png" width="384"></p>
<p>The object <code>fit.spline</code> also contains the values of the
P-splines coefficients:</p>
<table class="table">
<thead><tr class="header">
<th align="center">obj.coefficients</th>
<th align="center">plotId</th>
<th align="center">type</th>
<th align="center">genotype</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0.6965965</td>
<td align="center">c10r29</td>
<td align="center">timeNumber1</td>
<td align="center">G160</td>
</tr>
<tr class="even">
<td align="center">0.6685027</td>
<td align="center">c10r29</td>
<td align="center">timeNumber2</td>
<td align="center">G160</td>
</tr>
<tr class="odd">
<td align="center">0.6421887</td>
<td align="center">c10r29</td>
<td align="center">timeNumber3</td>
<td align="center">G160</td>
</tr>
<tr class="even">
<td align="center">0.6265465</td>
<td align="center">c10r29</td>
<td align="center">timeNumber4</td>
<td align="center">G160</td>
</tr>
<tr class="odd">
<td align="center">0.6263577</td>
<td align="center">c10r29</td>
<td align="center">timeNumber5</td>
<td align="center">G160</td>
</tr>
<tr class="even">
<td align="center">0.6420706</td>
<td align="center">c10r29</td>
<td align="center">timeNumber6</td>
<td align="center">G160</td>
</tr>
</tbody>
</table>
<p>The coefficients are then used to tag suspect time courses with the
function <code><a href="../../reference/detectSerieOut.html">detectSerieOut()</a></code>. This function performs a PCA on
the coefficients (from data.frame <code>coefDat</code>) per
<code>genotype</code> and calculates the pairwise angle between the
plants in the PCA plot. Plants are tagged when the mean angle is above
threshold (<code>thrPca)</code>, see the lines
<code>reason = angle</code> in the table below. The function also
calculates the pairwise-correlation of the coefficients per genotype.
Plants are tagged when the correlation is below a given threshold
(<code>thrCor</code>), see the lines <code>reason = mean corr</code> in
the table below. Finally the pairwise-ratios of the slopes of a linear
model fitted through the spline coefficients are computed. Plants are
tagged when the average pairwise-ratio is lower the a given threshold
(<code>thrSlope</code>), see the lines <code>reasion = slope</code> in
the table below.</p>
<p>For obvious reasons, the detection will only work when there are at
least three replicates per genotype. Genotypes with less than three
replicates will be skipped.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outVator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/detectSerieOut.html">detectSerieOut</a></span><span class="op">(</span>corrDat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                           predDat <span class="op">=</span> <span class="va">predDat</span>,</span>
<span>                           coefDat <span class="op">=</span> <span class="va">coefDat</span>,</span>
<span>                           trait <span class="op">=</span> <span class="st">"EffpsII_corr"</span>,</span>
<span>                           genotypes <span class="op">=</span> <span class="va">subGenoVator</span>,</span>
<span>                           thrCor <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                           thrPca <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                           thrSlope <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="center">plotId</th>
<th align="center">genotype</th>
<th align="center">reason</th>
<th align="center">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">c9r4</td>
<td align="center">G160</td>
<td align="center">mean corr</td>
<td align="center">0.6775630</td>
</tr>
<tr class="even">
<td align="center">c9r4</td>
<td align="center">G160</td>
<td align="center">angle</td>
<td align="center">47.4954954</td>
</tr>
<tr class="odd">
<td align="center">c9r4</td>
<td align="center">G160</td>
<td align="center">slope</td>
<td align="center">0.6058944</td>
</tr>
<tr class="even">
<td align="center">c3r43</td>
<td align="center">G055</td>
<td align="center">mean corr</td>
<td align="center">0.8921578</td>
</tr>
</tbody>
</table>
<p>For this subset of genotypes, 2 plants were tagged as outliers:</p>
<ul>
<li>c3r43 and c9r4 had both low correlations. In addition c9r4 also had
high angles and a low average ratio for the slope.</li>
</ul>
<p>The <code>outVator</code> can be visualized by selecting genotypes.
Here genotype G160 which has plant c9r4 tagged as outlier:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">outVator</span>, genotypes <span class="op">=</span> <span class="st">"G160"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotOutVator-1.png" width="768"></p>
<p>The figure above contains:</p>
<ul>
<li>(top) A scatter plot of the trait value on the y-axis and time on
the x-axis. Points are the raw or corrected data and lines are the
P-spline predictions, with one color per plant (in legend). Filled dots
represent outlying plants, open dots non-outlying plants.</li>
<li>(bottom left) A matrix with in the bottom right the correlations of
the plant scores as a heatmap. The scale is centered on 0.9 (the
correlation threshold) to see at a glance the outlying plants with low
correlations (usually correlation is high between plants). The top left
of the matrix shows the average slopes as a heatmap. The scale is
centered on 0.7 (the slope threshold) to see at a glance the outlying
plants with low average slope (usually average slopes are high between
plants).</li>
<li>(bottom right) A PCA plot of the plant scores. Usually, all plants
are grouped and the first axis explains most of the variation. When a
plant is outlying, it will be located apart from the other plants on the
second axis.</li>
</ul>
<p>It is possible to visualize only the plants tagged for one or two
reasons instead of all three. This can be done by specifying
e.g. <code>reason = slope</code> for only visualizing plants tagged
because of a low average slope. When doing so only the relevant plots
will be shown. So in this case only the upper left part of the
correlation plot and no PCA plot.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">outVator</span>, </span>
<span>     genotypes <span class="op">=</span> <span class="st">"G160"</span>, </span>
<span>     reason <span class="op">=</span> <span class="st">"slope"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotOutVatorSlope-1.png" width="768"></p>
<p>When numerical time was used to fit the splines, it can be used also
to plot the outliers using the option <code>useTimeNumber = TRUE</code>
and providing the column name in <code>timeNumber</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">outVator</span>, </span>
<span>     genotypes <span class="op">=</span> <span class="st">"G160"</span>,  </span>
<span>     useTimeNumber <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>     timeNumber <span class="op">=</span> <span class="st">"timeNumHour"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, the outlying plants can be removed from the data set…</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spatCorrectedVatorOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/removeSerieOut.html">removeSerieOut</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                                        serieOut <span class="op">=</span> <span class="va">outVator</span><span class="op">)</span></span>
<span><span class="co"># Check for time series outliers in data from which individual outlying </span></span>
<span><span class="co"># observations were already removed and to which a spatial adjustment has been applied</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatCorrectedVator</span><span class="op">[</span><span class="va">spatCorrectedVator</span><span class="op">$</span><span class="va">plotId</span> <span class="op">==</span> <span class="st">"c9r4"</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"EffpsII_corr"</span>, <span class="st">"EffpsII"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       EffpsII_corr EffpsII</span></span>
<span><span class="co">#&gt; 12377    0.5643125   0.559</span></span>
<span><span class="co">#&gt; 16648    0.6693775   0.669</span></span>
<span><span class="co">#&gt; 18073    0.7261539   0.727</span></span>
<span><span class="co">#&gt; 19502    0.7994927   0.799</span></span>
<span><span class="co">#&gt; 20933           NA      NA</span></span>
<span><span class="co">#&gt; 22361           NA      NA</span></span>
<span><span class="co"># Check the same value in the new corrected data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatCorrectedVatorOut</span><span class="op">[</span><span class="va">spatCorrectedVatorOut</span><span class="op">$</span><span class="va">plotId</span> <span class="op">==</span> <span class="st">"c9r4"</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"EffpsII_corr"</span>, <span class="st">"EffpsII"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       EffpsII_corr EffpsII</span></span>
<span><span class="co">#&gt; 12377           NA   0.559</span></span>
<span><span class="co">#&gt; 16648           NA   0.669</span></span>
<span><span class="co">#&gt; 18073           NA   0.727</span></span>
<span><span class="co">#&gt; 19502           NA   0.799</span></span>
<span><span class="co">#&gt; 20933           NA      NA</span></span>
<span><span class="co">#&gt; 22361           NA      NA</span></span></code></pre></div>
<p>… and from the predictions.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.splineOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/removeSerieOut.html">removeSerieOut</a></span><span class="op">(</span>fitSpline <span class="op">=</span> <span class="va">fit.spline</span>,</span>
<span>                                serieOut <span class="op">=</span> <span class="va">outVator</span><span class="op">)</span></span>
<span><span class="va">fit.splineNumOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/removeSerieOut.html">removeSerieOut</a></span><span class="op">(</span>fitSpline <span class="op">=</span> <span class="va">fit.splineNum</span>,</span>
<span>                                   serieOut <span class="op">=</span> <span class="va">outVator</span><span class="op">)</span></span></code></pre></div>
<p>It is possible to remove only the plants tagged for one or two
reasons instead of all three. This can be done by specifying
e.g. <code>reason = slope</code> for only removing plants tagged because
of a low average slope.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spatCorrectedVatorOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/removeSerieOut.html">removeSerieOut</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                                        serieOut <span class="op">=</span> <span class="va">outVator</span>,</span>
<span>                                        reason <span class="op">=</span> <span class="st">"slope"</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="impact-of-the-number-of-knots-on-the-smoothing">Impact of the number of knots on the smoothing<a class="anchor" aria-label="anchor" href="#impact-of-the-number-of-knots-on-the-smoothing"></a>
</h4>
<p>For one plant of the same data set, we fit the P-spline with 10 or 50
knots and visualize the predictions to compare the smoothness. We advise
the user to perform tests of the number of knots on a subset of plants
before running the function on all plants.</p>
<p><em>With 10 knots:</em></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp10k</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitSpline.html">fitSpline</a></span><span class="op">(</span>inDat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                   trait <span class="op">=</span> <span class="st">"EffpsII_corr"</span>,</span>
<span>                   plotIds <span class="op">=</span> <span class="st">"c10r29"</span>,</span>
<span>                   knots <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sp10k</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/fitSplineVatorKnots10-1.png" width="384"></p>
<p>The predicted curve is very smooth and, in this case, it is not
following precisely the real data curve shape. When comparing the plants
of a same genotype with this curve shape we might not identify the
outlying plant.</p>
<p><em>With 50 knots:</em></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp50k</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitSpline.html">fitSpline</a></span><span class="op">(</span>inDat <span class="op">=</span> <span class="va">spatCorrectedVator</span>,</span>
<span>                   trait <span class="op">=</span> <span class="st">"EffpsII_corr"</span>,</span>
<span>                   plotIds <span class="op">=</span> <span class="st">"c10r29"</span>,</span>
<span>                   knots <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sp50k</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/fitSplineVatorKnots50-1.png" width="384"></p>
<p>The predicted curve is less smooth and follows the actual curve
shape. This seems to be a good setting to detect strange curve shape
among the replicates of a genotype.</p>
</div>
</div>
<div class="section level3">
<h3 id="example-2">Example 2<a class="anchor" aria-label="anchor" href="#example-2"></a>
</h3>
<p>The data from the PhenoArch platform have been corrected for spatial
trends and individually outlying observations have been removed (see <a href="OutlierSingleObs_HTP.html"><strong>statgenHTP tutorial: 2. Outlier
detection for single observations</strong></a> and <a href="SpatialModel_HTP.html"><strong>statgenHTP tutorial: 3. Correction
for spatial trends</strong></a>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">spatCorrectedArch</span><span class="op">)</span>  </span>
<span><span class="va">subGenoArch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GenoA01"</span>, <span class="st">"GenoA02"</span>, <span class="st">"GenoA34"</span>, <span class="st">"GenoA04"</span>, <span class="st">"GenoB01"</span>, <span class="st">"GenoB02"</span>, <span class="st">"GenoB07"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit.splineArch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitSpline.html">fitSpline</a></span><span class="op">(</span>inDat <span class="op">=</span> <span class="va">spatCorrectedArch</span>, </span>
<span>                            trait <span class="op">=</span> <span class="st">"LeafArea_corr"</span>,</span>
<span>                            genotypes <span class="op">=</span> <span class="va">subGenoArch</span>,</span>
<span>                            knots <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                            minNoTP <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predDatArch</span> <span class="op">&lt;-</span> <span class="va">fit.splineArch</span><span class="op">$</span><span class="va">predDat</span></span>
<span><span class="va">coefDatArch</span> <span class="op">&lt;-</span> <span class="va">fit.splineArch</span><span class="op">$</span><span class="va">coefDat</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.splineArch</span>,</span>
<span>     plotIds <span class="op">=</span> <span class="st">"c11r9"</span>,</span>
<span>     plotType <span class="op">=</span>  <span class="st">"predictions"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotArch-1.png" width="384"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.splineArch</span>,</span>
<span>     plotIds <span class="op">=</span> <span class="st">"c11r9"</span>,</span>
<span>     plotType <span class="op">=</span>  <span class="st">"derivatives"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotArch-2.png" width="384"></p>
<p>Here, the <code>geno.decomp</code> option is also to split the plants
of each genotype those under well watered and water deficit conditions.
The outlier detection is run per treatment with a narrow angle
threshold</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outArch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/detectSerieOut.html">detectSerieOut</a></span><span class="op">(</span>corrDat <span class="op">=</span> <span class="va">spatCorrectedArch</span>,</span>
<span>                          predDat <span class="op">=</span> <span class="va">predDatArch</span>,</span>
<span>                          coefDat <span class="op">=</span> <span class="va">coefDatArch</span>,</span>
<span>                          trait <span class="op">=</span> <span class="st">"LeafArea_corr"</span>,</span>
<span>                          genotypes <span class="op">=</span> <span class="va">subGenoArch</span>,</span>
<span>                          thrCor <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                          thrPca <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                          thrSlope <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                          geno.decomp <span class="op">=</span> <span class="st">"geno.decomp"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="center">plotId</th>
<th align="center">genotype</th>
<th align="center">geno.decomp</th>
<th align="center">reason</th>
<th align="center">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">c13r6</td>
<td align="center">GenoA01</td>
<td align="center">WD_Panel1</td>
<td align="center">mean corr</td>
<td align="center">0.893585</td>
</tr>
<tr class="even">
<td align="center">c13r6</td>
<td align="center">GenoA01</td>
<td align="center">WD_Panel1</td>
<td align="center">angle</td>
<td align="center">14.472282</td>
</tr>
<tr class="odd">
<td align="center">c16r2</td>
<td align="center">GenoA01</td>
<td align="center">WD_Panel1</td>
<td align="center">angle</td>
<td align="center">13.054901</td>
</tr>
<tr class="even">
<td align="center">c20r24</td>
<td align="center">GenoA01</td>
<td align="center">WD_Panel1</td>
<td align="center">angle</td>
<td align="center">12.805672</td>
</tr>
<tr class="odd">
<td align="center">c21r56</td>
<td align="center">GenoA01</td>
<td align="center">WD_Panel1</td>
<td align="center">angle</td>
<td align="center">10.462828</td>
</tr>
<tr class="even">
<td align="center">c24r26</td>
<td align="center">GenoA01</td>
<td align="center">WD_Panel1</td>
<td align="center">angle</td>
<td align="center">13.075548</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">outArch</span>, genotypes <span class="op">=</span> <span class="st">"GenoA01"</span>, geno.decomp <span class="op">=</span> <span class="st">"WD_Panel1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotOutArch-1.png" width="768"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spatCorrectedArchOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/removeSerieOut.html">removeSerieOut</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">spatCorrectedArch</span>,</span>
<span>                                       serieOut <span class="op">=</span> <span class="va">outArch</span><span class="op">)</span></span>
<span><span class="co"># Check for time series outliers in data from which individual outlying </span></span>
<span><span class="co"># observations were already removed and to which a spatial adjustment has been applied</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatCorrectedArch</span><span class="op">[</span><span class="va">spatCorrectedArch</span><span class="op">$</span><span class="va">plotId</span> <span class="op">==</span> <span class="st">"c16r2"</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LeafArea_corr"</span>, <span class="st">"LeafArea"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       LeafArea_corr    LeafArea</span></span>
<span><span class="co">#&gt; 1       0.002564006 0.002871676</span></span>
<span><span class="co">#&gt; 2173    0.004164635 0.004066799</span></span>
<span><span class="co">#&gt; 3843    0.005768308 0.005690233</span></span>
<span><span class="co">#&gt; 5509    0.008211606 0.008043967</span></span>
<span><span class="co">#&gt; 7180    0.009454458 0.010399790</span></span>
<span><span class="co">#&gt; 10049   0.015047478 0.015390857</span></span>
<span><span class="co"># Check the same value in the new corrected data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatCorrectedArchOut</span><span class="op">[</span><span class="va">spatCorrectedArchOut</span><span class="op">$</span><span class="va">plotId</span> <span class="op">==</span> <span class="st">"c16r2"</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LeafArea_corr"</span>, <span class="st">"LeafArea"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       LeafArea_corr    LeafArea</span></span>
<span><span class="co">#&gt; 1                NA 0.002871676</span></span>
<span><span class="co">#&gt; 2173             NA 0.004066799</span></span>
<span><span class="co">#&gt; 3843             NA 0.005690233</span></span>
<span><span class="co">#&gt; 5509             NA 0.008043967</span></span>
<span><span class="co">#&gt; 7180             NA 0.010399790</span></span>
<span><span class="co">#&gt; 10049            NA 0.015390857</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-3">Example 3<a class="anchor" aria-label="anchor" href="#example-3"></a>
</h3>
<p>The data from the RootPhAir platform have not been corrected for
spatial trends but individually outlying observations have been removed
(see <a href="OutlierSingleObs_HTP.html"><strong>statgenHTP tutorial: 2.
Outlier detection for single observations</strong></a>).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">subGenoRoot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"2"</span>, <span class="st">"6"</span>, <span class="st">"8"</span>, <span class="st">"9"</span>, <span class="st">"10"</span>, <span class="st">"520"</span>, <span class="st">"522"</span><span class="op">)</span></span>
<span><span class="va">fit.splineRoot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fitSpline.html">fitSpline</a></span><span class="op">(</span>inDat <span class="op">=</span> <span class="va">noCorrectedRoot</span>,</span>
<span>                            trait <span class="op">=</span> <span class="st">"tipPos_y"</span>,</span>
<span>                            knots <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                            genotypes <span class="op">=</span> <span class="va">subGenoRoot</span>,</span>
<span>                            minNoTP <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                            useTimeNumber <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            timeNumber <span class="op">=</span> <span class="st">"thermalTime"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predDatRoot</span> <span class="op">&lt;-</span> <span class="va">fit.splineRoot</span><span class="op">$</span><span class="va">predDat</span></span>
<span><span class="va">coefDatRoot</span> <span class="op">&lt;-</span> <span class="va">fit.splineRoot</span><span class="op">$</span><span class="va">coefDat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">coefDatRoot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">coefDatRoot</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.splineRoot</span>,</span>
<span>     genotypes <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotRoot-1.png" width="672"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outRoot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/detectSerieOut.html">detectSerieOut</a></span><span class="op">(</span>corrDat <span class="op">=</span> <span class="va">noCorrectedRoot</span>,</span>
<span>                          predDat <span class="op">=</span> <span class="va">predDatRoot</span>,</span>
<span>                          coefDat <span class="op">=</span> <span class="va">coefDatRoot</span>,</span>
<span>                          trait <span class="op">=</span> <span class="st">"tipPos_y"</span>,</span>
<span>                          genotypes <span class="op">=</span> <span class="va">subGenoRoot</span>,</span>
<span>                          thrCor <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                          thrPca <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                          thrSlope <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">outRoot</span>,</span>
<span>     genotypes <span class="op">=</span> <span class="st">"6"</span><span class="op">)</span></span></code></pre></div>
<p><img src="OutlierSerieObs_HTP_files/figure-html/plotRootOut-1.png" width="672"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">noCorrectedRootOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/removeSerieOut.html">removeSerieOut</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">noCorrectedRoot</span>,</span>
<span>                                     serieOut <span class="op">=</span> <span class="va">outRoot</span><span class="op">)</span></span>
<span><span class="co"># Check one value annotated as outlier in the original corrected data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">noCorrectedRoot</span><span class="op">[</span><span class="va">noCorrectedRoot</span><span class="op">$</span><span class="va">plotId</span> <span class="op">==</span> <span class="st">"A_21_2"</span>, <span class="st">"tipPos_y"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.042857 3.057143       NA 2.317857 2.325000 2.371429</span></span>
<span><span class="co"># Check the same value in the new corrected data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">noCorrectedRootOut</span><span class="op">[</span><span class="va">noCorrectedRootOut</span><span class="op">$</span><span class="va">plotId</span> <span class="op">==</span> <span class="st">"A_21_2"</span>, <span class="st">"tipPos_y"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA NA NA NA NA NA</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="detection-of-outlier-plants-on-a-multi-criteria-basis-with-expert-rules">Detection of outlier plants on a multi-criteria basis, with expert
rules<a class="anchor" aria-label="anchor" href="#detection-of-outlier-plants-on-a-multi-criteria-basis-with-expert-rules"></a>
</h2>
<p>An outlier plant is defined as a biological replicate deviating from
the overall distribution of plants on a multi-criteria basis, regardless
of the quality of measurements. Detecting outlier plants can be done by
monitoring a single criterion, such as plant height or biomass. In this
case, a procedure for detecting outlying series of observations should
be used, as discussed in the previous sections. But taking into account
only one criterion can sometimes be restrictive in deciding whether a
plant is outlier or not. A multi-criteria approach will then be more
relevant. A multi-criteria method considers several traits jointly, with
rules set by experts depending on the species. We describe below the
approach followed on a maize experiment, see <span class="citation">(<a href="#ref-AlvarezPrado2019">Alvarez Prado et al. 2019</a>)</span>.</p>
<div class="section level3">
<h3 id="rules-in-the-case-of-maize">Rules in the case of maize<a class="anchor" aria-label="anchor" href="#rules-in-the-case-of-maize"></a>
</h3>
<p>We consider two categories of potentially outlier plants, namely
apparently <strong>too small</strong> or <strong>too large</strong>
plants. For the detection of unexpectedly small plants with likely
physiological disorders, the progression of leaf stages was considered
in addition to the time course of shoot biomass. Indeed, leaf appearance
rate carries a non-redundant information compared with biomass
(confirmed by standard correlation calculations). It usually presents a
low plant-to-plant variability except in case of severe disorders, and
is relatively insensitive to environmental cues other than temperature.
For the detection of unexpectedly large plants, potentially associated
with wrong genotype identification, combining plant height and biomass
can result in an efficient identification.</p>
</div>
<div class="section level3">
<h3 id="statistical-modelling-a-mixed-model-at-a-given-time-defined-by-the-expert">Statistical modelling: a mixed model at a given time (defined by the
expert)<a class="anchor" aria-label="anchor" href="#statistical-modelling-a-mixed-model-at-a-given-time-defined-by-the-expert"></a>
</h3>
<p>Each of the selected traits was measured (or estimated) at a specific
time (for example 24 d20°C for the PhenoArch data set), time just before
the beginning of the differentiation of the two watering treatments.
This allows to have more replicates per genotype. It also reduces the
dimensionality of the time courses to only one point, which will
simplify the statistical models to be implemented later.</p>
<div class="figure">
<img src="figures/multi_trait_approach.png" alt="Schematic representation of a multi-trait approach for detection of outlier plants (case of maize), from @AlvarezPrado2019." width="90%"><p class="caption">
Schematic representation of a multi-trait approach for detection of
outlier plants (case of maize), from <span class="citation">Alvarez
Prado et al. (<a href="#ref-AlvarezPrado2019">2019</a>)</span>.
</p>
</div>
<p>As shown above, traits are modeled with a mixed model that considers
fixed experiment (Env) effect and random genotypic (G), replicate (R)
and spatial (C) effects. The model can be fitted with the SpATS
R-package, (<span class="citation">Rodríguez-Álvarez et al. (<a href="#ref-RodAlv2018">2018</a>)</span>). Residuals (deviations) can be
directly computed from the fitting, with a confidence interval. Plants,
whose deviations for the criteria of leaf appearance rate and biomass
are less than the lower bound of this interval, are considered as
<strong>outlier small plants</strong>. Plants, whose deviations for the
criteria of plant height and biomass are greater than the upper bound of
the confidence interval, are considered as <strong>outlier large
plants</strong>.</p>
</div>
<div class="section level3">
<h3 id="implementation-in-statgenhtp">Implementation in statgenHTP<a class="anchor" aria-label="anchor" href="#implementation-in-statgenhtp"></a>
</h3>
<p>Mixed models are fitted with the R-package SpATS through the use of
the <code>detectSingleOutMaize</code> function, which was developed
specifically for the maize data, as described above. This function fits
a mixed model for each parameter, and tests whether the residual
deviations are lower (for the criteria considered for small plants) or
higher (for the criteria considered for big plants) than a specified
threshold.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phenoTParch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/createTimePoints.html">createTimePoints</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">PhenoarchDat1</span>,</span>
<span>                                experimentName <span class="op">=</span> <span class="st">"Phenoarch"</span>,</span>
<span>                                genotype <span class="op">=</span> <span class="st">"Genotype"</span>,</span>
<span>                                timePoint <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>                                plotId <span class="op">=</span> <span class="st">"pos"</span>,</span>
<span>                                rowNum <span class="op">=</span> <span class="st">"Row"</span>,</span>
<span>                                colNum <span class="op">=</span> <span class="st">"Col"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/detectSingleOutMaize.html">detectSingleOutMaize</a></span><span class="op">(</span><span class="va">phenoTParch</span>, </span>
<span>                              timeBeforeTrt <span class="op">=</span> <span class="st">"2017-04-27"</span>,</span>
<span>                              trait1 <span class="op">=</span> <span class="st">"Biomass"</span>,</span>
<span>                              trait2 <span class="op">=</span> <span class="st">"PlantHeight"</span>,</span>
<span>                              trait3 <span class="op">=</span> <span class="st">"phyllocron"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>detectSingleOutMaize</code> returns a list of 3 elements
:</p>
<ul>
<li>modDat: a data.frame with the used data set, the fitted values and
residuals calculated by the models, and the plants flagged as
outlier</li>
<li>smallPlants: a data.frame of the “small” plants detected as
outliers</li>
<li>bigPlants: a data.frame of the “big” plants detected as
outliers</li>
</ul>
<p>The table below shows the smallPlants data.frame.</p>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="center">timePoint</th>
<th align="center">plotId</th>
<th align="center">genotype</th>
<th align="center">Scenario</th>
<th align="center">population</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">5811</td>
<td align="center">2017-04-27</td>
<td align="center">c5r3</td>
<td align="center">GenoA06</td>
<td align="center">WW</td>
<td align="center">Panel1</td>
</tr>
<tr class="even">
<td align="left">8476</td>
<td align="center">2017-04-27</td>
<td align="center">c6r57</td>
<td align="center">GenoA57</td>
<td align="center">WW</td>
<td align="center">Panel1</td>
</tr>
<tr class="odd">
<td align="left">8594</td>
<td align="center">2017-04-27</td>
<td align="center">c7r2</td>
<td align="center">GenoB07</td>
<td align="center">WD</td>
<td align="center">Panel2</td>
</tr>
<tr class="even">
<td align="left">8986</td>
<td align="center">2017-04-27</td>
<td align="center">c7r18</td>
<td align="center">GenoB11</td>
<td align="center">WD</td>
<td align="center">Panel2</td>
</tr>
<tr class="odd">
<td align="left">17106</td>
<td align="center">2017-04-27</td>
<td align="center">c12r50</td>
<td align="center">GenoA30</td>
<td align="center">WD</td>
<td align="center">Panel1</td>
</tr>
<tr class="even">
<td align="left">18085</td>
<td align="center">2017-04-27</td>
<td align="center">c13r28</td>
<td align="center">GenoA27</td>
<td align="center">WD</td>
<td align="center">Panel1</td>
</tr>
</tbody>
</table>
<hr>
</div>
<div class="section level3">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-AlvarezPrado2019" class="csl-entry">
Alvarez Prado, Santiago, Isabelle Sanchez, Llorenç Cabrera-Bosquet,
Antonin Grau, Claude Welcker, François Tardieu, and Nadine Hilgert.
2019. <span>“To Clean or Not to Clean Phenotypic Datasets for Outlier
Plants in Genetic Analyses?”</span> <em>Journal of Experimental
Botany</em> 70 (15): 3693–98. <a href="https://doi.org/10.1093/jxb/erz191" class="external-link">https://doi.org/10.1093/jxb/erz191</a>.
</div>
<div id="ref-Currie2002" class="csl-entry">
Currie, I D, and M Durban. 2002. <span>“Flexible Smoothing with
<span>P</span>-Splines: A Unified Approach.”</span> <em>Statistical
Modelling</em> 2 (4): 333–49. <a href="https://doi.org/10.1191/1471082x02st039ob" class="external-link">https://doi.org/10.1191/1471082x02st039ob</a>.
</div>
<div id="ref-Eilers2015" class="csl-entry">
Eilers, Paul H. C., Brian D. Marx, and Maria Durbán. 2015. <span>“Twenty
Years of p-Splines.”</span> <em>Statistics and Operations Research
Transactions</em> 39 (2): 149–86.
</div>
<div id="ref-Eubank1999" class="csl-entry">
Eubank, Randall L. 1999. <em>Nonparametric Regression and Spline
Smoothing</em>. Statistics: A Series of Textbooks and Monographs. CRC
Press.
</div>
<div id="ref-Hugelier2016" class="csl-entry">
Hugelier, S., O. Devos, and C. Ruckebusch. 2016. <span>“Chapter 14 - a
Smoothness Constraint in Multivariate Curve Resolution-Alternating Least
Squares of Spectroscopy Data.”</span> In <em>Resolving Spectral
Mixtures</em>, edited by Cyril Ruckebusch, 30:453–76. Data Handling in
Science and Technology. Elsevier. <a href="https://doi.org/10.1016/B978-0-444-63638-6.00014-0" class="external-link">https://doi.org/10.1016/B978-0-444-63638-6.00014-0</a>.
</div>
<div id="ref-RodAlv2018" class="csl-entry">
Rodríguez-Álvarez, María, Martin P. Boer, Fred van Eeuwijk, and Paul H.
C. Eilers. 2018. <span>“Correcting for Spatial Heterogeneity in Plant
Breeding Experiments with p-Splines.”</span> <em>Spatial Statistics</em>
23 (October): 52–71. <a href="https://doi.org/10.1016/j.spasta.2017.10.003" class="external-link">https://doi.org/10.1016/j.spasta.2017.10.003</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Emilie J Millet, Maria Xose Rodriguez Alvarez, Diana Marcela Perez Valencia, Isabelle Sanchez, Nadine Hilgert, Bart-Jan van Rossum, Fred van Eeuwijk, Martin Boer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
